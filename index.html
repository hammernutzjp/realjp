<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortable Table with Pagination and Search (DataTables)</title>

    <!-- Include jQuery and DataTables CSS/JS from CDN -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        img {
            max-width: 100px;
            height: auto;
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <h2>Sortable Table with Pagination (Using DataTables)</h2>
    <table id="data-table" class="display">
        <thead>
            <tr>
                <th>Image</th>
                <th>Description</th>
                <th>Price</th>
                <th>Size</th>
                <th>Age</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <script>
        $(document).ready(function() {
            let data = [];

            // Fetch data from JSON
            fetch('kenbiya_tokyo_data.json')
                .then(response => response.json())
                .then(jsonData => {
                    data = jsonData;
                    populateTable(data);

                    // Initialize DataTable
                    const table = $('#data-table').DataTable({
                        paging: true,
                        searching: true,
                        ordering: true,
                        pageLength: 25, // Set the default number of rows per page
                        language: {
                            searchPlaceholder: "Search..."
                        }
                    });

                    // Reapply lazy loading after table updates (search, paginate, etc.)
                    table.on('draw', function() {
                        lazyLoadImages();
                    });

                    // Initial lazy load trigger
                    lazyLoadImages();
                })
                .catch(error => console.error('Error loading JSON data:', error));

            // Populate the table with data
            function populateTable(dataToRender) {
                const tableBody = $('#table-body');
                tableBody.empty(); // Clear existing rows

                dataToRender.forEach(row => {
                    const tr = $('<tr></tr>');

                    // Image column with lazy loading
                    const tdImage = $('<td></td>');
                    const img = $('<img>')
                        .attr('src', '') // Set empty initially
                        .attr('data-src', row.img_sources) // Store actual image URL
                        .attr('alt', 'Property Image')
                        .attr('loading', 'lazy') // Native lazy loading
                        .addClass('lazy-img'); // Class for lazy loading
                    tdImage.append(img);
                    tr.append(tdImage);

                    // Description column with link
                    const tdDescription = $('<td></td>');
                    const descLink = $('<a></a>').attr('href', row.url).attr('target', '_blank').text(row.main_texts);
                    tdDescription.append(descLink);
                    tr.append(tdDescription);

                    // Price column
                    const tdPrice = $('<td></td>').text(row.price_texts);
                    tr.append(tdPrice);

                    // Size column
                    const tdSize = $('<td></td>').text(row.size);
                    tr.append(tdSize);

                    // Age column
                    const tdAge = $('<td></td>').text(row.age);
                    tr.append(tdAge);

                    tableBody.append(tr);
                });
            }

            // Lazy load images for visible rows
            function lazyLoadImages() {
                $('.lazy-img').each(function() {
                    const img = $(this);
                    if (!img.attr('src') || img.attr('src') === '') {
                        img.attr('src', img.attr('data-src')).css('opacity', 1);
                    }
                });
            }
        });
    </script>
</body>
</html>
